# トップページにブログを表示してみよう

## クエリセットを理解しよう

1. モデルのインポート

   shell ターミナルを起動し、モデルをインポートします。

   ```
   (djangobros_venv) ~/DjangoBros/django_blog$ python3 manage.py shell

    ♯ blogs/models.pyのBlogモデルをインポート
    >>> from blogs.models import Blog

    ♯ Blogインスタンスのデータを全取得する
    >>> Blog.objects.all()
    ♯ 取得されたデータ一覧
    <QuerySet [<Blog: 最初の投稿>, <Blog: Hello World>]>
   ```

   Blog インスタンスのデータを全取得すると、前回作成したブログ記事を一覧として表示させることができます。  
   このように取得したデータのことを**クエリセット**と呼びます。

   objects は、all()以外にも様々なメソッドを持っています。

   【get()条件に合う 1 つのインスタンスを取得】

   ```
   # idが1のインスタンスを取得
   >>> Blog.objects.get(id=1)
   ```

   【filter()条件に合うインスタンスを全て取得】

   ```
   # titleフィールドに文字列"Django"を含む全ての記事を取得
   >>> Blog.objects.filter(title__contains="Django")
   ```

   【order_by()を引数に指定したフィールドを基準にして昇順で取得】

   ```
   # idの順に取得
   >>> Blog.objects.order_by('id')

   # フィールド名の前に - をつけると降順で取得できる
   >>> Blog.objects.order_by('-id')
   ```

   複数のメソッドと組み合わせて使うことも可能です。

   【filter()と order_by()を組み合わせて使う】

   ```
   # titleフィールドに文字列"Django"を含む記事を"id"の降順で取得
   >>> Blog.objects.filter(title__contains="Django").order_by('-id')
   ```

   次に、create()メソッドを紹介します。  
    これを使えば、ターミナルからインスタンスを作成することができます。

   【create()インスタンスを作る】

   ```
   # 各フィールドの値を指定してBlogインスタンスを作成
   >>> Blog.objects.create(title="コマンドから作られたブログ", text="createメソッドでブログを作ってみました。")
   ```

   id、日時に関するフィールドは、自動で値が入るので指定する必要はありません。  
   クエリセットに変数を代入することも可能です。  
   また、「インスタンス名.フィールド名」とコードを書けば、プロパティを出力することもできます。

   【id=1 の Blog インスタンスを変数 blog に代入】

   ```
   >>> blog = Blog.objects.get(id=1)
   # id=1のBlogインスタンスのタイトルを出力
   >>> blog.title
   ```

   複数の Blog インスタンスを代入する時は、変数名を blogs と複数形にするとわかりやすくなります。

   【全ての Blog インスタンスを変数 blogs に代入】

   ```
   >>> blogs = Blog.objects.all()
   # id=1のBlogインスタンスのタイトルを出力
   >>> blogs[0].title
   ```

## テンプレートタグを使ってクエリセットを HTML で表示

ここまでで、DB に保管されたインスタンスを自分が指定した条件で取得できるようになりました。  
あとは、取得したインスタンスを HTML で表示させるだけです。

HTML で表示する内容は View でで意義することができます。  
先ほどターミナル画面で打ったようなコードを View に書いてクエリセットを取得し、そのクエリセットを HTML ファイルに渡して表示させるという流れになります。

それでは、クエリセットを HTML で表示させる準備をしていきます。  
views.py を開き、以下のように書き換えましょう。

```
# django_blog/blogs/views.py

from django.shortcuts import render
from .models import Blog

def index(request):
    blogs = Blog.objects.order_by('-created_datetime')
    return render(request, 'blogs/index.html', {'blogs': blogs})
```

これまでのコードに比べて、3 箇所変更が追加されています。  
1 箇所目は、2 行目で Blog モデルを models.py からインポートしている点です。  
これによってこのファイル内で Blog モデルを使用できるようになりました。

2 箇所目目は、`blogs = Blog.objects.order_by('-created_datetime')`の部分です。  
先ほど覚えたクエリセットが使用されています。  
DB に保存されている Blogs インスタンスを作成日順に並べたクエリセットを取得し、blogs 変数に代入しています。

3 個所目は、`{'blogs': blogs}`の部分です。
render 関数の中で`{}`と書かれている部分では、テンプレート(HTML)に渡したいデータを自由に定義することができます。  
Python の辞書型と同様に定義するので、`キー`と`値`を書かなければいけません。 　
今回の場合、キーは`'blogs'`で値は`変数blogs（つまり、1つ上の行で指定したクエリセット）`となります。

この記述により、index.html では「blogs」と書くだけでクエリセットを表示させることができるようになります。

今回は、たまたまキーと値の名前が一緒でしたが、キーの名前は自由に定義可能です。  
注意しなければならないのは、キーは文字列なのでシングルクォートで囲み、値は今回の場合では変数なのでクォートで囲ます変数名をそのまま書きます。

これで、クエリセットのデータをテンプレート（HTML）に渡すことができるので、実際に表示させてみましょう。  
index.html を開いて以下のように変更を加えてください。

```
<h1>ブログサイト</h1>
<p>ここはトップページです</p>
{{ blogs }}
```

上記のように View から渡されたデータはキーに指定した文字列を`{{ }}`で囲むことで表示することができます。  
`{{ }}`のことを`テンプレートタグ`と呼びます。

コードを保存して、トップページを表示してみましょう。  
クエリセットが表示されているはずです。

Blog のクエリセットを表示させることができましたが、これだと Blog のインスタンスのリストを表示させているだけです。  
リストの 1 つ 1 つの要素をきちんと表示させたいときに使うのが for 文です。  
以下のコードのように、Django では HTML に直接 Python コードを書くことが可能です。  
この for 文では、変数 blog に blogs リストのインスタンスを順番に代入して表示させています。

```
♯ index.html

<h1>ブログサイト</h1>
<p>ここはトップページです。</p>
{% for blog in blogs %}
  {{ blog.title }}
{% endfor %}
```

ここで新しい`{% %}`が出てきました。  
これもテンプレートタグと言いますが`{{ }}`と違って、このタグの中身は実際のページには表示されません。

テンプレートタグの使い分けとして、`{{ }}`にはページに表示させたいもの、  
`{% %}`にはぺージに表示させたくない処理コードを記述することになります。

また、通常の Python コードと違い、for 文の終わりを表す`{% endfor %}`というコードが必要になるので、忘れないように注意が必要です。

index.html では、`{ blog.title }`のように`「インスタンス.フィールド名」`と書くことで、各インスタンスのタイトルを表示させています。  
`{ blog.title }`と書けば、各記事の本文が表示されるようになります。

なお、フィールド名を省略して`{{ blog }}`とだけ書くこともできます。  
この場合、models.py の`def __str__(self):`で`return self.title`と指定しているので、タイトルが表示されます。

ここまでの流れを図にすると、以下のようになります。  
これが理解できていれば、Django の基礎的な流れはもう完璧です。

![alt text](Img/Django_MVT.png)

最後に、今のままだと見栄えが悪いので、綺麗に表示されるように HTML タグで各要素を囲んであげましょう。  
本当は CSS を使えばもっと綺麗にデザインできますが、このチュートリアルでは簡単化のために CSS の設定をせず、HTML タグに style を指定して最低限のデザインを整えます。

ついでに、`{{ blog.text }}`とコードを追加して各記事の本文も表示させます。  
実際の下のコードには、`{{ blog.text |truncatechars:100 }}`と書いてあります。  
`|truncatechars:100`の部分は`テンプレートタグフィルター`と呼ばれるもので、条件をつけて表示させることができます。  
ここで使っているフィルターは表示する文字数を制限するもので、ここでは本文の最初の１００文字だけを表示するように条件をつけています。  
フィルターは他にもありますので、別の機会に紹介します。

```
# index.html

<!DOCTYPE html>
<html>
    <head>
        <title>ブログ管理サイト</title>
    </head>
    <body>
        <h1 style="text-align: center;">My Blog</h1>
        <div style="width: 70%;margin: 0px auto;">
            <hr />
                {% for blog in blogs %}
                <div>
                    <h3>{{ blog.title }}</h3>
                    <div>{{ blog.text | truncatechars:100 }}</div>
                </div>
            <hr />
            {% endfor %}
        </div>
    </body>
</html>
```

綺麗に表示されましたか？  
いよいよ次が最後のレッスンです。  
各記事の詳細ページを作って、このサイトを完成させましょう。
